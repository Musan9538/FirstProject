# データベース設計書

## 1. テーブル一覧

| テーブル物理名 | テーブル論理名 | 説明 |
|----------------|----------------|------|
| users          | ユーザー       | システムを利用するユーザー情報を管理 |
| harvests       | 収穫           | 収穫量の記録を管理 |

## 2. テーブル定義

### 2.1 users テーブル

#### テーブル説明
システムを利用するユーザーの情報を管理するテーブル。
一般ユーザーと管理者の両方の情報を格納する。

#### カラム定義

| カラム物理名        | カラム論理名     | データ型    | 主キー | NOT NULL | デフォルト値 | 備考 |
|---------------------|------------------|-------------|:------:|:--------:|--------------|------|
| id                  | ID               | integer     | ○      | ○        | 自動採番     | システム内部での識別子 |
| username            | ユーザー名       | string      |        | ○        |              | ログイン時に使用。一意制約あり |
| password_digest     | パスワード       | string      |        | ○        |              | bcryptによるハッシュ化済みパスワード |
| is_admin            | 管理者フラグ     | boolean     |        | ○        | false        | 管理者権限の有無 |
| created_at          | 作成日時         | datetime    |        | ○        | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at          | 更新日時         | datetime    |        | ○        | CURRENT_TIMESTAMP | レコード更新日時 |

#### インデックス

| インデックス名      | カラム           | 種類           | 説明 |
|---------------------|------------------|----------------|------|
| index_users_on_username | username     | UNIQUE        | ユーザー名の一意性を保証 |

### 2.2 harvests テーブル

#### テーブル説明
収穫量の記録を管理するテーブル。
各ユーザーが入力した収穫日と収穫量の情報を格納する。

#### カラム定義

| カラム物理名        | カラム論理名     | データ型    | 主キー | NOT NULL | デフォルト値 | 備考 |
|---------------------|------------------|-------------|:------:|:--------:|--------------|------|
| id                  | ID               | integer     | ○      | ○        | 自動採番     | システム内部での識別子 |
| user_id             | ユーザーID       | integer     |        | ○        |              | usersテーブルの外部キー |
| date                | 収穫日           | date        |        | ○        |              | 収穫を行った日付 |
| amount              | 収穫量           | decimal     |        | ○        |              | 収穫量（kg）、小数点第1位まで |
| created_at          | 作成日時         | datetime    |        | ○        | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at          | 更新日時         | datetime    |        | ○        | CURRENT_TIMESTAMP | レコード更新日時 |

#### インデックス

| インデックス名           | カラム           | 種類    | 説明 |
|--------------------------|------------------|---------|------|
| index_harvests_on_user_id | user_id        | 通常    | ユーザーによる検索の効率化 |
| index_harvests_on_date    | date           | 通常    | 日付による検索の効率化 |

## 3. リレーションシップ

### 3.1 ER図
```
[users] 1 ----< [harvests]
```

### 3.2 リレーションの詳細

| リレーション元   | リレーション先 | 関係     | 説明 |
|------------------|----------------|----------|------|
| users            | harvests       | 1対多    | 1人のユーザーが複数の収穫記録を持つ |

## 4. データの制約

### 4.1 users テーブル
- ユーザー名は一意であること
- パスワードは入力時に必須（更新時は任意）
- 管理者フラグは必須（デフォルトはfalse）

### 4.2 harvests テーブル
- 収穫日は必須
- 収穫量は必須かつ0.1以上の数値
- user_idは必須かつusersテーブルに存在するID

## 5. データ操作

### 5.1 データの削除ポリシー
- ユーザーを削除する場合、関連する収穫記録も削除（dependent: :destroy）
- 収穫記録の削除は、作成者本人または管理者のみ可能

### 5.2 データの更新ポリシー
- ユーザー情報の更新は管理者のみ可能
- 収穫記録の更新機能は提供しない（削除して再登録） 